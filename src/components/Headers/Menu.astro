---
import { translations } from "../../locales.js";
import "../../assets/css/main.css";
import "../../assets/css/menu.css";
import { Image } from "astro:assets";
import SearchContent from "../js/SearchContent.jsx";
import roatanLogo from "../../assets/img/logo/Roatan-LogoSimple.png";
import Flags from "./flags.astro";
import MenuMovil from "./menu_movil.astro";
import fs from "fs";
import path from "path";
import matter from "gray-matter";
import MenuOverlay from "./menu_overlay.astro";

const lang = Astro.props?.lang ?? "es";
const t = translations[lang] ?? translations["es"];

const menuItems = Object.entries(t.menu).map(([key, label]) => ({
  path: key,
  label,
}));

function loadMarkdownFromDir(dirPath) {
  if (!fs.existsSync(dirPath)) return [];
  return fs.readdirSync(dirPath).map((filename) => {
    const filePath = path.join(dirPath, filename);
    const fileContent = fs.readFileSync(filePath, "utf-8");
    const { data } = matter(fileContent);
    return {
      ...data,
      title: data.title || filename.replace(".md", ""),
      slug: data.slug || filename.replace(".md", ""),
      tags: data.tags || [],
      category: dirPath.includes("posts")
        ? "blog"
        : dirPath.includes("ports")
          ? "port-experience"
          : "discover-beyond",
    };
  });
}

const baseDir = path.resolve(`./src`);
const content = [
  ...loadMarkdownFromDir(`${baseDir}/posts/${lang}`),
  ...loadMarkdownFromDir(`${baseDir}/ports/${lang}`),
];
---

<div
  id="menu_desktop"
  class="w-screen relative lg:-mt-24 hidden lg:flex lg:sticky flex-row-reverse top-0 justify-between px-6 py-3 bg-transparent items-center z-30 transition-colors duration-300 ease-in-out"
>
  <a
    id="logo_menu"
    class="absolute lg:left-24 xl:left-36 lg:w-20 lg:h-auto transition-colors duration-300 ease-in-out"
    href={lang === "es" ? "/es/home" : "/en/home"}
  >
    <Image
      id="roatan_logo"
      class="w-full h-auto"
      src={roatanLogo}
      alt="logo"
      loading="eager"
    />
  </a>
  <nav id="desktop_menu_items" class="text-white flex items-center hidden">
    {
      menuItems.map((item) => (
        <a
          class="menu_element mx-3 font-bebas underline-grow text-lg xl:text-2xl "
          href={`/${lang}/${item.path}/`}
        >
          {item.label}
        </a>
      ))
    }
    <SearchContent lang={lang} content={content} client:load />
    <div
      class="flex flex-row items-center social_media_container gap-2 xl:gap-4 pt-1"
    >
      <a href="https://www.facebook.com/PortRoatan" target="_blank"
        ><div class="icon-mask icon-mask-face"></div></a
      >
      <a href="https://www.instagram.com/portroatan" target="_blank"
        ><div class="icon-mask icon-mask-ig"></div></a
      >

      <a
        href="https://www.tripadvisor.com.mx/Attraction_Review-g292019-d25290415-Reviews-Roatan_Cruise_Port-Roatan_Bay_Islands.html"
        target="_blank"><div class="icon-mask icon-mask-trip"></div></a
      >
    </div>

    <Flags lang={lang} />
  </nav>
  <div
    id="desktop_burger_menu"
    class="desktop_burger mx-4 mt-2 z-40 cursor-pointer"
  >
    <span class="desktop_burger_line"></span>
    <span class="desktop_burger_line"></span>
    <span class="desktop_burger_line"></span>
  </div>
</div>
<MenuOverlay lang={lang} content={content} />
<div
  id="burger_menu"
  class="absolute lg:hidden bg-transparent top-9 right-5 z-40"
>
  <label class="burger z-40" for="burger">
    <input type="checkbox" id="burger" />
    <span class="burger-line bg-white"></span>
    <span class="burger-line bg-white"></span>
    <span class="burger-line bg-white"></span>
  </label>
</div>
<MenuMovil lang={lang} content={content} />
<script>
  const burger = document.getElementById("burger");
  const menuMovil = document.getElementById("menu_movil");
  const burgerLines = document.querySelectorAll("#burger_menu .burger-line");

  if (burger) {
    burger.addEventListener("click", () => {
      if (!menuMovil) return;

      const isOpen = menuMovil.classList.contains("hidden");

      if (isOpen) {
        menuMovil.classList.remove("hidden");
        menuMovil.classList.add("flex");
        document.body.classList.add("overflow-hidden");

        burgerLines.forEach((line) => {
          line.classList.remove("bg-white");
          line.classList.add("bg-[var(--secondary-color)]");
        });
      } else {
        menuMovil.classList.remove("flex");
        menuMovil.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");

        burgerLines.forEach((line) => {
          line.classList.remove("bg-[var(--secondary-color)]");
          line.classList.add("bg-white");
        });
      }
    });

    document.querySelectorAll("#menu_movil a").forEach((link) => {
      link.addEventListener("click", () => {
        if (menuMovil) {
          menuMovil.classList.remove("flex");
          menuMovil.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");

          burgerLines.forEach((line) => {
            line.classList.remove("bg-black");
            line.classList.add("bg-white");
          });
        }

        (burger as HTMLInputElement).checked = false;
      });
    });
  }

  window.addEventListener("scroll", function () {
    const menu = document.getElementById("menu_desktop");
    const desktopMenuItems = document.getElementById("desktop_menu_items");
    const desktopBurgerMenu = document.getElementById("desktop_burger_menu");
    if (!menu) return;

    if (window.scrollY > 400) {
      menu.classList.remove("bg-transparent");
      menu.classList.add("bg-[var(--primary-color)]");
      desktopMenuItems.classList.remove("hidden");
      desktopMenuItems.classList.add("flex");
      desktopBurgerMenu.classList.remove("flex");
      desktopBurgerMenu.classList.add("hidden");
    } else {
      menu.classList.remove("bg-[var(--primary-color)]");
      menu.classList.add("bg-transparent");
      desktopMenuItems.classList.remove("flex");
      desktopMenuItems.classList.add("hidden");
      desktopBurgerMenu.classList.remove("hidden");
      desktopBurgerMenu.classList.add("flex");
    }
  });
</script>
<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const burgerDesktop = document.getElementById("desktop_burger_menu");
    const overlay = document.getElementById("menu_overlay");
    const logoMenu = document.getElementById("logo_menu");
    const overlayDivs = overlay?.querySelectorAll(".div1, .div3, .div5");
    const overlayDivsX = overlay?.querySelectorAll(".div2, .div4");

    if (!burgerDesktop || !overlay) return;

    burgerDesktop.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      const isHidden = overlay.classList.contains("hidden");

      if (isHidden) {
        overlay.classList.remove("hidden");
        logoMenu.classList.add("hidden");
        document.body.classList.add("overflow-hidden");
        burgerDesktop.classList.add("is-open");

        overlayDivs.forEach((div) => {
          div.classList.remove("hideY");
          div.classList.add("showY");
        });
        overlayDivsX.forEach((div) => {
          div.classList.remove("hideX");
          div.classList.add("showX");
        });
      } else {
        burgerDesktop.classList.remove("is-open");

        overlayDivs.forEach((div) => {
          div.classList.remove("showY");
          div.classList.add("hideY");
        });
        overlayDivsX.forEach((div) => {
          div.classList.remove("showX");
          div.classList.add("hideX");
        });

        setTimeout(() => {
          overlay.classList.add("hidden");
          logoMenu.classList.remove("hidden");
          document.body.classList.remove("overflow-hidden");
        }, 500);
      }
    });

    overlay.addEventListener("click", () => {
      burgerDesktop.classList.remove("is-open");

      overlayDivs.forEach((div) => {
        div.classList.remove("showY");
        div.classList.add("hideY");
      });
      overlayDivsX.forEach((div) => {
        div.classList.remove("showX");
        div.classList.add("hideX");
      });

      setTimeout(() => {
        overlay.classList.add("hidden");
        logoMenu.classList.remove("hidden");
        document.body.classList.remove("overflow-hidden");
      }, 500);
    });
  });
</script>

<style>
  .desktop_burger {
    width: 32px;
    height: 24px;
    position: relative;
  }

  .desktop_burger_line {
    position: absolute;
    left: 0;
    width: 100%;
    height: 3px;
    background: white;
    transition: all 0.3s ease;
  }

  .desktop_burger_line:nth-child(1) {
    top: 0;
  }

  .desktop_burger_line:nth-child(2) {
    top: 10px;
  }

  .desktop_burger_line:nth-child(3) {
    bottom: 0;
  }

  .desktop_burger.is-open .desktop_burger_line:nth-child(1) {
    transform: rotate(45deg);
    top: 10px;
    background-color: var(--secondary-color);
  }

  .desktop_burger.is-open .desktop_burger_line:nth-child(2) {
    opacity: 0;
    background-color: var(--secondary-color);
  }

  .desktop_burger.is-open .desktop_burger_line:nth-child(3) {
    transform: rotate(-45deg);
    bottom: 11px;
    background-color: var(--secondary-color);
  }
</style>
